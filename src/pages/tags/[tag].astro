---
interface TagPage {
  tag: string;
  posts: any[];
}

import { getCollection } from 'astro:content';
import { collections } from '@content/config';
import MainLayout from '@layouts/MainLayout.astro';
import Card from '@components/Card.astro';

export async function getStaticPaths() {

  const pages: any[] = [];

  let allPosts: any[] = []
  let tags: string[] = [];

  const colls = Object.keys(collections);

  // Get all tags on every category
  for await (let c of colls) {
    const coll = await getCollection(c as any);
    allPosts = allPosts.concat(coll);
    tags = tags.concat([...new Set(coll.map((post) => post.data.tags).flat())]);
  }

  // Remove duplicated tags
  tags = [...new Set(tags)];

  // Create a object for each tag to save its posts
  const tagPages: TagPage[] = tags.map((t: string) => { return { tag: t, posts: [] } });

  // Interate each post and save it on its tags, a post can have several tags
  allPosts.forEach((post: any) => {
    post.data.tags.forEach((postTag: string) => {
      tagPages.forEach((tagPage: TagPage) => {
        if (tagPage.tag == postTag) {
          tagPage.posts.push(post);
        }
      });
    });
  });

  // Build each tag page with its posts
  tagPages.forEach((tagPage: TagPage) => {
    pages.push({
      params: { tag: tagPage.tag },
      props: {
        tag: tagPage.tag,
        posts: tagPage.posts.filter(tagPage => (tagPage.slug))
      },
    })
  });

  return pages;
}

const param = Astro.params;
const props = Astro.props;
---

<MainLayout
  title={`Blog ${param.tag} | Kevin Fiorentino`}
  description={`Kevin Fiorentino's blog about ${param.tag}`}
  image=''
>
  <div>
    <p class="dark:text-white">Tag</p>
    <h1 class="capitalize dark:text-white">
      {param.tag}
    </h1>
  </div>
  <div role="list" class="cards-grid">
    {
      props.posts.map((item: any) => (
        <Card
          slug={item.slug}
          collection={item.collection}
          title={item.data.title}
          description={item.data.description}
          image={item.data.image}
          pubDate={item.data.pubDate}
          tags={item.data.tags}
        >
        </Card>
      ))
    }
  </div>
</MainLayout>
